<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Take Assessment - Beat Claude</title>
  <link rel="stylesheet" href="/css/style.css">
  <style>
    body {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--bg);
      padding: 2rem 1rem;
    }

    .register-wrapper {
      width: 100%;
      max-width: 460px;
    }

    .register-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 1.25rem;
      box-shadow: 0 40px 100px rgba(0, 0, 0, 0.4);
      overflow: hidden;
    }

    .register-header {
      background: var(--surface2);
      border-bottom: 1px solid var(--border);
      padding: 2.5rem;
      text-align: center;
    }

    .register-body {
      padding: 2rem;
    }

    .assessment-info {
      background: var(--gold-glow);
      border: 1px solid rgba(212, 168, 71, 0.2);
      border-radius: 0.75rem;
      padding: 1.25rem;
      margin-bottom: 2rem;
    }

    .assessment-role {
      font-weight: 800;
      color: var(--gold);
      font-size: 1.125rem;
      letter-spacing: -0.01em;
    }

    .assessment-meta {
      font-size: 0.8125rem;
      color: var(--text2);
      margin-top: 0.5rem;
      display: flex;
      gap: 1.25rem;
      flex-wrap: wrap;
    }

    .assessment-meta span::before {
      margin-right: 0.25rem;
    }

    .error-section {
      background: #fee2e2;
      border: 1px solid #fca5a5;
      border-radius: 0.5rem;
      padding: 1rem;
      margin-bottom: 1.25rem;
      color: var(--red-600);
      font-size: 0.875rem;
      display: none;
    }

    .error-section.show {
      display: block;
    }
  </style>
</head>

<body>
  <div class="register-wrapper">
    <div class="register-card">
      <div class="register-header">
        <div class="logo">‚öó</div>
        <h1>Beat Claude</h1>
        <p class="subtitle">Complete your registration to begin</p>
      </div>
      <div class="register-body">
        <!-- Assessment info block -->
        <div id="assessmentInfo" class="assessment-info">
          <div class="assessment-role" id="roleTitle">Loading assessment...</div>
          <div class="assessment-meta" id="assessmentMeta"></div>
        </div>

        <div id="errorMsg" class="error-section"></div>

        <form id="registerForm">
          <div class="form-group">
            <label class="form-label">Full Name</label>
            <input type="text" id="fullName" class="form-input" placeholder="Enter your full name" required
              autocomplete="name">
          </div>

          <div class="form-group">
            <label class="form-label">Email Address</label>
            <input type="email" id="email" class="form-input" placeholder="your@email.com" required
              autocomplete="email">
          </div>

          <div class="form-group">
            <label class="form-label">Phone Number <span style="color:var(--slate-400)">(optional)</span></label>
            <input type="tel" id="phone" class="form-input" placeholder="+1 234 567 8900" autocomplete="tel">
          </div>

          <button type="submit" id="submitBtn" class="btn btn-primary"
            style="width:100%; margin-top: 1rem; height: 52px; font-size: 1rem;">
            Begin Evaluation ‚Üí
          </button>
        </form>

        <p style="font-size: 0.75rem; color: var(--slate-400); text-align:center; margin-top: 1rem;">
          By starting you agree that the assessment is your own work.
        </p>
      </div>
    </div>
  </div>

  <script src="/js/app.js"></script>
  <script>
    let assessmentId = null;

    async function init() {
      const params = new URLSearchParams(window.location.search);
      assessmentId = parseInt(params.get('id'));

      if (!assessmentId) {
        showError('No assessment ID provided in the URL.');
        return;
      }

      await loadAssessmentInfo();
    }

    async function loadAssessmentInfo() {
      try {
        const data = await api.get(`/public/assessments/${assessmentId}`);
        const assessment = data.assessment;

        document.getElementById('roleTitle').textContent = assessment.role_title || assessment.title;
        document.getElementById('assessmentMeta').innerHTML = `
          <span>üìÅ ${assessment.department || 'General'}</span>
          <span>‚è±Ô∏è ${assessment.duration_minutes} minutes</span>
          <span>üìù ${assessment.question_count || '?'} questions</span>
        `;
      } catch (err) {
        showError('This assessment is not available or has been closed.');
      }
    }

    function showError(msg) {
      const el = document.getElementById('errorMsg');
      el.textContent = msg;
      el.classList.add('show');
    }

    document.getElementById('registerForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const fullName = document.getElementById('fullName').value.trim();
      const email = document.getElementById('email').value.trim();
      const phone = document.getElementById('phone').value.trim();

      if (!fullName || !email) {
        showError('Please fill in all required fields.');
        return;
      }

      const btn = document.getElementById('submitBtn');
      btn.disabled = true;
      btn.textContent = '‚è≥ Registering...';

      try {
        const formData = new FormData();
        formData.append('assessment_id', assessmentId);
        formData.append('full_name', fullName);
        formData.append('email', email);
        formData.append('phone', phone);

        const res = await fetch(`${API_URL}/candidates/register`, {
          method: 'POST',
          body: formData
        });

        const data = await res.json();

        if (res.ok && data.success) {
          // Store session
          localStorage.setItem('candidateSession', JSON.stringify({
            candidateId: data.candidate_id,
            name: fullName,
            email: email,
            assessmentId: assessmentId
          }));

          window.location.href = `/pages/take-test.html?candidate=${data.candidate_id}`;
        } else {
          showError(data.detail || 'Registration failed. Please try again.');
          btn.disabled = false;
          btn.textContent = 'üöÄ Start Assessment';
        }
      } catch (err) {
        showError('Network error. Please check your connection and try again.');
        btn.disabled = false;
        btn.textContent = 'üöÄ Start Assessment';
      }
    });

    init();
  </script>
</body>

</html>