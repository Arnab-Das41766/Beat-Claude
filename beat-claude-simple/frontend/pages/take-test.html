<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Assessment in Progress - Beat Claude</title>
  <link rel="stylesheet" href="/css/style.css">
  <style>
    body {
      background: var(--bg);
      min-height: 100vh;
    }

    .test-header {
      background: var(--surface);
      backdrop-filter: blur(12px);
      border-bottom: 1px solid var(--border);
      position: sticky;
      top: 0;
      z-index: 100;
      padding: 0 1.5rem;
      height: 64px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .header-logo {
      width: 32px;
      height: 32px;
      background: var(--gold);
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #0c0c0e;
      font-size: 16px;
    }

    .header-title {
      font-weight: 700;
      font-size: 1.25rem;
      color: var(--text);
      font-family: 'Playfair Display', serif;
    }

    .header-title span {
      color: var(--gold);
      font-style: italic;
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 1.5rem;
    }

    .timer-display {
      font-family: 'JetBrains Mono', monospace;
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--gold);
      padding: 0.35rem 1rem;
      background: var(--gold-dim);
      border: 1px solid rgba(212, 168, 71, 0.2);
      border-radius: 0.5rem;
      min-width: 90px;
      text-align: center;
    }

    .timer-display.warning {
      background: #fee2e2;
      color: var(--red-600);
      animation: pulse 1s infinite;
    }

    @keyframes pulse {

      0%,
      100% {
        opacity: 1;
      }

      50% {
        opacity: 0.65;
      }
    }

    .candidate-label {
      font-size: 0.875rem;
      color: var(--slate-500);
      font-weight: 500;
    }

    .test-layout {
      max-width: 1100px;
      margin: 0 auto;
      padding: 2rem 1.5rem;
      display: grid;
      grid-template-columns: 220px 1fr;
      gap: 1.5rem;
    }

    @media (max-width: 768px) {
      .test-layout {
        grid-template-columns: 1fr;
      }

      .sidebar {
        display: none;
      }
    }

    /* Sidebar */
    .sidebar {
      position: sticky;
      top: 80px;
      align-self: start;
    }

    .sidebar-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 1rem;
      padding: 1.25rem;
    }

    .sidebar-title {
      font-weight: 600;
      font-size: 0.875rem;
      color: var(--slate-700);
      margin-bottom: 1rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .nav-grid {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 0.4rem;
      margin-bottom: 1rem;
    }

    .nav-btn {
      width: 100%;
      aspect-ratio: 1;
      border: 1px solid var(--border);
      border-radius: 0.5rem;
      font-size: 0.8125rem;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.2s;
      background: var(--surface2);
      color: var(--text3);
    }

    .nav-btn:hover {
      background: var(--surface3);
      color: var(--text);
      border-color: var(--border2);
    }

    .nav-btn.current {
      background: var(--gold);
      color: #0c0c0e;
      border-color: var(--gold);
    }

    .nav-btn.answered {
      background: var(--teal-dim);
      color: var(--teal);
      border-color: rgba(44, 196, 164, 0.2);
    }

    .nav-btn.answered.current {
      background: var(--gold);
      color: #0c0c0e;
      border-color: var(--gold);
    }

    .sidebar-stats {
      border-top: 1px solid var(--border);
      padding-top: 1.25rem;
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .stat-row {
      display: flex;
      justify-content: space-between;
      font-size: 0.8125rem;
    }

    .stat-label {
      color: var(--text3);
      font-weight: 600;
    }

    .stat-val {
      font-weight: 700;
      color: var(--text);
    }

    .stat-val.green {
      color: #059669;
    }

    /* Main question area */
    .question-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 1rem;
      padding: 2rem;
    }

    .progress-section {
      margin-bottom: 1.75rem;
    }

    .progress-labels {
      display: flex;
      justify-content: space-between;
      font-size: 0.8125rem;
      color: var(--text3);
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 0.625rem;
    }

    .progress-track {
      height: 6px;
      background: var(--surface3);
      border-radius: 3px;
      overflow: hidden;
    }

    .progress-fill-bar {
      height: 100%;
      background: linear-gradient(90deg, var(--gold), var(--gold2));
      border-radius: 3px;
      transition: width 0.3s ease;
    }

    .question-meta {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin-bottom: 0.75rem;
      flex-wrap: wrap;
    }

    .q-number {
      font-size: 0.85rem;
      color: var(--slate-500);
    }

    .q-type-badge {
      padding: 0.2rem 0.6rem;
      border-radius: 9999px;
      font-size: 0.7rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .q-type-mcq {
      background: #dbeafe;
      color: #1d4ed8;
    }

    .q-type-short_answer {
      background: #f0fdf4;
      color: #15803d;
    }

    .q-type-scenario {
      background: #fdf4ff;
      color: #7c3aed;
    }

    .q-skill-badge {
      padding: 0.35rem 0.875rem;
      border-radius: 0.5rem;
      font-size: 0.75rem;
      font-weight: 700;
      background: var(--surface2);
      color: var(--text2);
      border: 1px solid var(--border);
    }

    .q-points {
      font-size: 0.8125rem;
      font-weight: 600;
      color: var(--text3);
      margin-left: auto;
    }

    .question-text {
      font-family: 'Playfair Display', serif;
      font-size: 1.75rem;
      font-weight: 700;
      color: var(--text);
      line-height: 1.4;
      margin-bottom: 2.5rem;
    }

    /* MCQ options */
    .mcq-options {
      display: flex;
      flex-direction: column;
      gap: 0.65rem;
      margin-bottom: 1.5rem;
    }

    .mcq-option {
      display: flex;
      align-items: center;
      gap: 1.25rem;
      padding: 1.25rem 1.5rem;
      border: 1.5px solid var(--border);
      border-radius: 0.875rem;
      background: var(--surface2);
      cursor: pointer;
      transition: all 0.2s;
      user-select: none;
    }

    .mcq-option:hover {
      border-color: var(--border2);
      background: var(--surface3);
    }

    .mcq-option.selected {
      border-color: var(--gold);
      background: var(--gold-dim);
    }

    .option-letter {
      width: 36px;
      height: 36px;
      border-radius: 10px;
      border: 1.5px solid var(--border2);
      background: var(--surface3);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 800;
      font-size: 0.9375rem;
      color: var(--text2);
      flex-shrink: 0;
      transition: all 0.2s;
    }

    .mcq-option.selected .option-letter {
      background: var(--gold);
      border-color: var(--gold);
      color: #0c0c0e;
    }

    .option-text {
      font-size: 1rem;
      font-weight: 500;
      color: var(--text);
      line-height: 1.5;
    }

    /* Text answer */
    .text-answer {
      width: 100%;
      padding: 1.25rem 1.5rem;
      background: var(--surface2);
      border: 1.5px solid var(--border);
      border-radius: 0.875rem;
      font-size: 1rem;
      line-height: 1.6;
      resize: vertical;
      min-height: 200px;
      font-family: inherit;
      color: var(--text);
      transition: all 0.2s;
      margin-bottom: 2rem;
    }

    .text-answer:focus {
      outline: none;
      border-color: var(--gold);
      background: var(--surface3);
      box-shadow: 0 0 0 4px var(--gold-glow);
    }

    /* Navigation buttons */
    .nav-buttons {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 1rem;
    }

    /* Submit section */
    .submit-section {
      margin-top: 1.5rem;
      text-align: center;
    }

    .submit-hint {
      font-size: 0.8rem;
      color: var(--slate-400);
      margin-top: 0.5rem;
    }

    /* Loading */
    .loading-state {
      text-align: center;
      padding: 4rem 2rem;
    }

    .loading-state .spinner {
      margin: 0 auto 1rem;
    }

    .loading-text {
      color: var(--slate-500);
    }

    /* Modal overlay */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 200;
      padding: 1rem;
    }

    .modal-box {
      background: var(--surface);
      border: 1px solid var(--border2);
      border-radius: 1.25rem;
      padding: 2.5rem;
      max-width: 440px;
      width: 100%;
      text-align: center;
      box-shadow: 0 40px 100px rgba(0, 0, 0, 0.5);
    }

    .modal-icon {
      font-size: 3.5rem;
      margin-bottom: 1rem;
      display: block;
    }

    .modal-title {
      font-size: 1.5rem;
      font-weight: 800;
      color: var(--text);
      margin-bottom: 0.75rem;
      letter-spacing: -0.02em;
    }

    .modal-body {
      color: var(--slate-500);
      font-size: 0.9rem;
      margin-bottom: 1.5rem;
    }

    .modal-actions {
      display: flex;
      gap: 0.75rem;
    }

    .modal-actions .btn {
      flex: 1;
    }

    /* Submitting overlay */
    .submitting-overlay {
      position: fixed;
      inset: 0;
      background: rgba(12, 12, 14, 0.98);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 300;
      backdrop-filter: blur(12px);
    }

    .submitting-content {
      text-align: center;
    }

    .submitting-icon {
      font-size: 3rem;
      margin-bottom: 1rem;
      display: block;
      animation: bounce 1s infinite;
    }

    @keyframes bounce {

      0%,
      100% {
        transform: translateY(0);
      }

      50% {
        transform: translateY(-8px);
      }
    }
  </style>
</head>

<body>
  <!-- Header -->
  <header class="test-header animate-fade-up">
    <div class="header-left">
      <div class="header-logo">‚öó</div>
      <span class="header-title">Beat <span>Claude</span></span>
    </div>
    <div class="header-right">
      <span id="candidateLabel" class="candidate-label uppercase-label" style="font-size: 0.625rem;"></span>
      <div id="timerDisplay" class="timer-display">--:--</div>
    </div>
  </header>

  <!-- Loading state -->
  <div id="loadingState" class="loading-state">
    <div class="spinner"></div>
    <p class="loading-text">Loading your assessment...</p>
  </div>

  <!-- Test layout -->
  <div id="testLayout" class="test-layout hidden">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="sidebar-card">
        <div class="sidebar-title">Questions</div>
        <div id="navGrid" class="nav-grid"></div>
        <div class="sidebar-stats">
          <div class="stat-row">
            <span class="stat-label">Answered</span>
            <span id="answeredCount" class="stat-val green">0</span>
          </div>
          <div class="stat-row">
            <span class="stat-label">Remaining</span>
            <span id="remainingCount" class="stat-val">0</span>
          </div>
          <div class="stat-row">
            <span class="stat-label">Total</span>
            <span id="totalCount" class="stat-val">0</span>
          </div>
        </div>
      </div>
    </aside>

    <!-- Question Area -->
    <div>
      <div class="question-card">
        <!-- Progress -->
        <div class="progress-section">
          <div class="progress-labels">
            <span>Progress</span>
            <span id="progressLabel">0%</span>
          </div>
          <div class="progress-track">
            <div id="progressBar" class="progress-fill-bar" style="width: 0%"></div>
          </div>
        </div>

        <!-- Question Meta -->
        <div class="question-meta">
          <span id="qNumber" class="q-number">Question 1 of 10</span>
          <span id="qTypeBadge" class="q-type-badge"></span>
          <span id="qSkillBadge" class="q-skill-badge"></span>
          <span id="qPoints" class="q-points">10 pts</span>
        </div>

        <!-- Question Text -->
        <div id="questionText" class="question-text"></div>

        <!-- MCQ Options (hidden by default) -->
        <div id="mcqContainer" class="mcq-options hidden"></div>

        <!-- Text Answer (shown for non-MCQ) -->
        <textarea id="textAnswer" class="text-answer hidden" placeholder="Type your answer here..." rows="7"></textarea>

        <!-- Navigation -->
        <div class="nav-buttons">
          <button id="prevBtn" class="btn btn-secondary" onclick="previousQuestion()" disabled>
            ‚Üê Previous
          </button>
          <button id="nextBtn" class="btn btn-primary" onclick="nextQuestion()">
            Next ‚Üí
          </button>
        </div>
      </div>

      <!-- Submit Section -->
      <div class="submit-section">
        <button class="btn btn-primary btn-lg" onclick="confirmSubmit()"
          style="background: linear-gradient(135deg, #059669, #047857);">
          ‚úì Submit Assessment
        </button>
        <p class="submit-hint">Make sure you've answered all questions before submitting</p>
      </div>
    </div>
  </div>

  <!-- Submit Confirmation Modal -->
  <div id="submitModal" class="modal-overlay hidden">
    <div class="modal-box">
      <span class="modal-icon">‚ö†Ô∏è</span>
      <div class="modal-title">Submit Assessment?</div>
      <div class="modal-body">
        You have answered <strong id="modalAnswered">0</strong> of
        <strong id="modalTotal">0</strong> questions.<br>
        Once submitted, you cannot change your answers.
      </div>
      <div class="modal-actions">
        <button class="btn btn-secondary" onclick="closeModal('submitModal')">Cancel</button>
        <button class="btn btn-primary" onclick="submitAssessment()"
          style="background: linear-gradient(135deg, #059669, #047857);">
          Confirm & Submit
        </button>
      </div>
    </div>
  </div>

  <!-- Time Up Modal -->
  <div id="timeUpModal" class="modal-overlay hidden">
    <div class="modal-box">
      <span class="modal-icon">‚è∞</span>
      <div class="modal-title">Time's Up!</div>
      <div class="modal-body">Your assessment time has expired. Your answers will be submitted automatically.</div>
      <div class="modal-actions">
        <button class="btn btn-primary" onclick="forceSubmit()" style="width: 100%;">OK, Submit Now</button>
      </div>
    </div>
  </div>

  <!-- Submitting Overlay -->
  <div id="submittingOverlay" class="submitting-overlay hidden">
    <div class="submitting-content">
      <span class="submitting-icon">üöÄ</span>
      <h2
        style="font-size: 1.5rem; font-weight: 800; color: var(--text); margin-bottom: 0.75rem; letter-spacing: -0.02em;">
        Submitting your answers...
      </h2>
      <p style="color: var(--text2); font-weight: 500;">Please wait, do not close this tab.</p>
      <div class="loading" style="margin-top: 1.5rem;">
        <div class="spinner"></div>
      </div>
    </div>
  </div>

  <script src="/js/app.js"></script>
  <script>
    let candidateId = null;
    let questions = [];
    let answers = {}; // { questionId: { answer_text, selected_option } }
    let currentIndex = 0;
    let timeRemaining = 0;
    let timerInterval = null;
    let testStartTime = Date.now();

    async function init() {
      const session = localStorage.getItem('candidateSession');
      if (!session) {
        window.location.href = '/';
        return;
      }

      const sess = JSON.parse(session);
      const urlParams = new URLSearchParams(window.location.search);
      const urlCandidateId = parseInt(urlParams.get('candidate'));

      if (!urlCandidateId || urlCandidateId !== sess.candidateId) {
        window.location.href = '/';
        return;
      }

      candidateId = sess.candidateId;
      document.getElementById('candidateLabel').textContent = sess.name || '';

      await loadQuestions();
    }

    async function loadQuestions() {
      try {
        const data = await candidates.getTest(candidateId);

        if (!data.success) {
          alert(data.detail || 'Error loading questions');
          window.location.href = '/';
          return;
        }

        questions = data.questions || [];
        timeRemaining = data.duration_minutes * 60;
        testStartTime = Date.now();

        document.getElementById('loadingState').classList.add('hidden');
        document.getElementById('testLayout').classList.remove('hidden');

        document.getElementById('totalCount').textContent = questions.length;

        buildNavGrid();
        showQuestion(0);
        startTimer();
      } catch (err) {
        console.error('Load error:', err);
        alert('Failed to load questions. Please refresh.');
      }
    }

    function buildNavGrid() {
      const grid = document.getElementById('navGrid');
      grid.innerHTML = questions.map((q, i) => `
        <button class="nav-btn" id="navBtn${i}" onclick="goToQuestion(${i})">${i + 1}</button>
      `).join('');
    }

    function updateNavGrid() {
      questions.forEach((q, i) => {
        const btn = document.getElementById(`navBtn${i}`);
        if (!btn) return;
        btn.className = 'nav-btn';
        if (answers[q.id]) btn.classList.add('answered');
        if (i === currentIndex) btn.classList.add('current');
      });

      const answered = Object.keys(answers).length;
      document.getElementById('answeredCount').textContent = answered;
      document.getElementById('remainingCount').textContent = questions.length - answered;

      const pct = questions.length > 0 ? Math.round(answered / questions.length * 100) : 0;
      document.getElementById('progressBar').style.width = pct + '%';
      document.getElementById('progressLabel').textContent = pct + '%';
    }

    function showQuestion(index) {
      // Save current answer first
      saveCurrentAnswer();

      currentIndex = index;
      const q = questions[index];

      document.getElementById('qNumber').textContent = `Question ${index + 1} of ${questions.length}`;

      // Type badge
      const typeBadge = document.getElementById('qTypeBadge');
      const typeClass = 'q-type-' + q.type.toLowerCase().replace('_', '_');
      typeBadge.className = 'q-type-badge ' + typeClass;
      typeBadge.textContent = q.type.replace('_', ' ');

      document.getElementById('qSkillBadge').textContent = q.skill || '';
      document.getElementById('qPoints').textContent = (q.max_score || 10) + ' pts';
      document.getElementById('questionText').textContent = q.question_text;

      const mcqContainer = document.getElementById('mcqContainer');
      const textArea = document.getElementById('textAnswer');
      const saved = answers[q.id];

      if (q.type === 'MCQ' && q.options && q.options.length > 0) {
        mcqContainer.classList.remove('hidden');
        textArea.classList.add('hidden');

        const letters = ['A', 'B', 'C', 'D', 'E', 'F'];
        const selectedOpt = saved ? saved.selected_option : '';

        mcqContainer.innerHTML = q.options.map((opt, i) => `
          <label class="mcq-option${selectedOpt === letters[i] ? ' selected' : ''}"
                 onclick="selectMCQ('${q.id}', '${letters[i]}')">
            <div class="option-letter">${letters[i]}</div>
            <div class="option-text">${opt.replace(/^[A-F][\.\)]\s*/, '')}</div>
          </label>
        `).join('');
      } else {
        mcqContainer.classList.add('hidden');
        textArea.classList.remove('hidden');
        textArea.value = saved ? (saved.answer_text || '') : '';
      }

      // Update nav buttons
      document.getElementById('prevBtn').disabled = index === 0;
      document.getElementById('nextBtn').textContent = index === questions.length - 1 ? 'Review ‚úì' : 'Next ‚Üí';

      updateNavGrid();
    }

    function selectMCQ(questionId, letter) {
      answers[questionId] = { selected_option: letter, answer_text: '' };

      // Update visual
      document.querySelectorAll('.mcq-option').forEach(el => el.classList.remove('selected'));
      const clicked = event.currentTarget;
      clicked.classList.add('selected');
      updateNavGrid();
    }

    function saveCurrentAnswer() {
      if (questions.length === 0 || currentIndex >= questions.length) return;
      const q = questions[currentIndex];
      if (q.type === 'MCQ') {
        // MCQ is saved via selectMCQ click handler
        return;
      }
      const text = document.getElementById('textAnswer').value.trim();
      if (text) {
        answers[q.id] = { answer_text: text, selected_option: '' };
      } else {
        delete answers[q.id];
      }
    }

    function goToQuestion(index) {
      showQuestion(index);
    }

    function previousQuestion() {
      if (currentIndex > 0) showQuestion(currentIndex - 1);
    }

    function nextQuestion() {
      if (currentIndex < questions.length - 1) {
        showQuestion(currentIndex + 1);
      }
    }

    function startTimer() {
      updateTimerDisplay();
      timerInterval = setInterval(() => {
        timeRemaining--;
        updateTimerDisplay();

        if (timeRemaining <= 300) {
          document.getElementById('timerDisplay').classList.add('warning');
        }

        if (timeRemaining <= 0) {
          clearInterval(timerInterval);
          document.getElementById('timeUpModal').classList.remove('hidden');
        }
      }, 1000);
    }

    function updateTimerDisplay() {
      const m = Math.floor(timeRemaining / 60);
      const s = timeRemaining % 60;
      document.getElementById('timerDisplay').textContent =
        `${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
    }

    function confirmSubmit() {
      saveCurrentAnswer();
      const answered = Object.keys(answers).length;
      document.getElementById('modalAnswered').textContent = answered;
      document.getElementById('modalTotal').textContent = questions.length;
      document.getElementById('submitModal').classList.remove('hidden');
    }

    function closeModal(id) {
      document.getElementById(id).classList.add('hidden');
    }

    async function submitAssessment() {
      closeModal('submitModal');
      await doSubmit();
    }

    async function forceSubmit() {
      closeModal('timeUpModal');
      await doSubmit();
    }

    async function doSubmit() {
      saveCurrentAnswer();
      clearInterval(timerInterval);

      document.getElementById('submittingOverlay').classList.remove('hidden');

      const timeSpentMinutes = Math.round((Date.now() - testStartTime) / 60000);

      const payload = questions.map(q => {
        const ans = answers[q.id] || {};
        return {
          question_id: q.id,
          answer_text: ans.answer_text || '',
          selected_option: ans.selected_option || ''
        };
      });

      try {
        const data = await candidates.submit(candidateId, payload, timeSpentMinutes);

        if (data.success) {
          localStorage.removeItem('candidateSession');
          window.location.href = '/pages/test-submitted.html';
        } else {
          document.getElementById('submittingOverlay').classList.add('hidden');
          alert(data.detail || 'Submission failed. Please try again.');
        }
      } catch (err) {
        document.getElementById('submittingOverlay').classList.add('hidden');
        alert('Submission failed: ' + (err.message || 'Network error. Please try again.'));
      }
    }

    window.addEventListener('beforeunload', (e) => {
      if (timeRemaining > 0) {
        e.preventDefault();
        e.returnValue = '';
      }
    });

    init();
  </script>
</body>

</html>